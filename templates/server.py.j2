"""
Auto-generated pfSense MCP server.

Generated by: python -m generator
Source: openapi-spec.json (pfSense REST API v2)
Tools: {{ tool_count }}

DO NOT EDIT THIS FILE DIRECTLY.
Fix the generator or templates instead, then re-run.
"""

from __future__ import annotations

import os
from typing import Any

import httpx
from fastmcp import FastMCP

mcp = FastMCP("pfSense")


class PfSenseClient:
    """HTTP client for pfSense REST API v2."""

    def __init__(self) -> None:
        self.host = os.environ.get("PFSENSE_HOST", "https://192.168.1.1")
        self.api_key = os.environ.get("PFSENSE_API_KEY", "")
        self.verify_ssl = os.environ.get("PFSENSE_VERIFY_SSL", "false").lower() in (
            "true",
            "1",
            "yes",
        )
        self._client: httpx.AsyncClient | None = None

    async def _get_client(self) -> httpx.AsyncClient:
        if self._client is None or self._client.is_closed:
            self._client = httpx.AsyncClient(
                base_url=self.host.rstrip("/"),
                headers={"X-API-Key": self.api_key},
                verify=self.verify_ssl,
                timeout=30.0,
            )
        return self._client

    async def request(
        self,
        method: str,
        path: str,
        params: dict[str, Any] | None = None,
        json_body: dict[str, Any] | list | None = None,
    ) -> dict[str, Any]:
        """Make an API request and return the response."""
        client = await self._get_client()

        # Filter out None values from params
        if params:
            params = {k: v for k, v in params.items() if v is not None}

        try:
            resp = await client.request(
                method=method.upper(),
                url=path,
                params=params or None,
                json=json_body,
            )
            try:
                data = resp.json()
            except Exception:
                data = {"code": resp.status_code, "status": "error", "data": resp.text}

            # Unwrap successful responses
            if isinstance(data, dict) and data.get("code") == 200:
                return data.get("data", data)

            return data
        except httpx.ConnectError as e:
            return {"error": f"Connection failed: {e}. Check PFSENSE_HOST."}
        except httpx.ReadTimeout:
            return {"error": "Request timed out. The pfSense host may be slow or unreachable."}
        except Exception as e:
            return {"error": f"Request failed: {type(e).__name__}: {e}"}


_client = PfSenseClient()


@mcp.tool()
async def pfsense_report_issue(
    tool_name: str,
    error_message: str,
    parameters_used: dict[str, Any],
    notes: str = "",
) -> str:
    """Report an unexpected pfSense MCP tool error by composing a GitHub issue command.

    This tool does NOT make any HTTP calls. It returns a ready-to-paste
    `gh issue create` command that the user can run to file a bug report.

    tool_name: The MCP tool that produced the error (e.g. pfsense_get_firewall_rules)
    error_message: The error message or response body returned by the tool
    parameters_used: The parameters that were passed to the failing tool call
    notes: Any additional context about what you were trying to accomplish
    """
    import json as _json

    params_block = _json.dumps(parameters_used, indent=2, default=str)
    notes_section = f"\n\n## Notes\n\n{notes}" if notes else ""

    body = (
        f"## Tool\n\n`{tool_name}`\n\n"
        f"## Error\n\n```\n{error_message}\n```\n\n"
        f"## Parameters\n\n```json\n{params_block}\n```\n\n"
        f"## Repro Steps\n\n"
        f"1. Call `{tool_name}` with the parameters above\n"
        f"2. Observe the error response"
        f"{notes_section}"
    )

    escaped_body = body.replace("'", "'\\''")
    escaped_title = f"Bug: {tool_name} returns unexpected error".replace("'", "'\\''")

    return (
        f"Run this command to file the issue:\n\n"
        f"gh issue create --repo abl030/pfsense-mcp "
        f"--label bug --label mcp-reported "
        f"--title '{escaped_title}' "
        f"--body '{escaped_body}'"
    )

{{ tool_code }}
